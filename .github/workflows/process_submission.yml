name: Process Submission

on:
  pull_request_target:
    types: [opened, synchronize, reopened]
    paths:
      - 'submissions/**.enc'

permissions:
  contents: write

jobs:
  process-submission:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Base (Main)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.ref }} # Get scripts from main
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Identify PR Files
        id: find_files
        run: |
          # Fetch the PR branch so we can diff against it
          git fetch origin pull/${{ github.event.pull_request.number }}/head:pr_branch
          
          # Get list of files changed in the PR vs the base branch
          CHANGED_FILES=$(git diff --name-only main pr_branch | grep 'submissions/.*\.enc$' || true)
          echo "files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          
          # Actually checkout the PR files into the submissions folder 
          # so the script can read them
          git checkout pr_branch -- submissions/

      - name: Process and Score
        env:
          SUBMISSION_PRIVATE_KEY: ${{ secrets.SUBMISSION_PRIVATE_KEY }}
          TEST_LABELS_CSV: ${{ secrets.TEST_LABELS_CSV }}
          CHANGED_FILES: ${{ steps.find_files.outputs.files }}
        run: |
          python .github/scripts/process_submission.py

      - name: Commit Leaderboard Update
        run: |
          git config user.name "SubmissionBot"
          git config user.email "bot@noreply.github.com"
          git add leaderboard.csv submissions/ # Adding the decrypted CSVs if you want them saved
          
          # Only commit if something actually changed
          if ! git diff --cached --quiet; then
            git commit -m "Update leaderboard from PR #${{ github.event.pull_request.number }}"
            git push origin HEAD:${{ github.event.pull_request.base.ref }}
          fi
