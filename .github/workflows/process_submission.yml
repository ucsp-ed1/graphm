name: Process Submission

on:
  pull_request_target:
    types: [opened, synchronize, reopened]
    paths:
      - 'submissions/**.enc'

permissions:
  contents: write
  pull-requests: write

jobs:
  process-submission:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Base (Main)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.ref }} # Get scripts from main
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Identify PR Files
        id: find_files
        run: |
          # 1. Fetch the PR head and the base branch fully
          git fetch origin ${{ github.event.pull_request.base.ref }}
          git fetch origin pull/${{ github.event.pull_request.number }}/head:pr_branch
          
          # 2. Find the "Merge Base" (the point where the PR started)
          BASE_SHA=$(git merge-base origin/${{ github.event.pull_request.base.ref }} pr_branch)
          
          # 3. Diff from that base to the PR tip
          CHANGED_FILES=$(git diff --name-only --diff-filter=A $BASE_SHA pr_branch | grep 'submissions/.*\.enc$' || true)
          
          echo "files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "Detected files: $CHANGED_FILES"
          
          # 4. Checkout ONLY those specific files from the PR branch
          if [ -z "$CHANGED_FILES" ]; then
            echo "No new submissions."
          else
            git checkout pr_branch -- $CHANGED_FILES
          fi
          

      - name: Process and Score
        env:
          SUBMISSION_PRIVATE_KEY: ${{ secrets.SUBMISSION_PRIVATE_KEY }}
          TEST_LABELS_CSV: ${{ secrets.TEST_LABELS_CSV }}
          CHANGED_FILES: ${{ steps.find_files.outputs.files }}
        run: |
          python .github/scripts/process_submission.py


      - name: Commit Leaderboard Update
        run: |
          git config user.name "SubmissionBot"
          git config user.email "bot@noreply.github.com"
          
         
          git add docs/leaderboard.csv
          
          
          if ! git diff --cached --quiet; then
            git commit -m "Update leaderboard scores from PR #${{ github.event.pull_request.number }} [skip ci]"
            git push origin HEAD:${{ github.event.pull_request.base.ref }}
          fi

      - name: Post Score and Close PR
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Post the summary comment
          if [ -f "submission_summary.md" ]; then
            gh pr comment ${{ github.event.pull_request.number }} --body-file submission_summary.md
          fi
          
          # Close the PR without merging
          gh pr close ${{ github.event.pull_request.number }} --comment "Submission processed. The leaderboard has been updated, and this PR is now closed to keep the repository clean. Thank you!"
